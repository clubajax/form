<!DOCTYPE HTML>
<html lang="en">

<head>
    <title>Test Dropdown</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
        integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <script src="src/test-files.js"></script>
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            padding: 20px 20px 100px 20px;
            margin-bottom: 100px;
            font-family: sans-serif;
        }

        ui-dropdown {
            margin-bottom: 20px;
        }

        .abs-mid {
            position: absolute;
            top: 300px;
            left: 300px;
        }

        .abs-bot {
            position: absolute;
            bottom: 100px;
            right: 100px;
            width: 300px;
        }

        .top-right {
            position: absolute;
            top: 150px;
            right: 100px;
        }
    </style>
</head>

<body>
    <h1>Test Dropdown</h1>
    <div id="mocha"></div>
    <div id="tests">
        <input autofocus />
    </div>
    <script>

        mocha.setup('bdd');

        describe('UiDropdown', function () {

            this.timeout(3000);

            const
                describe = window.describe,
                test = window.test,
                dom = window.dom,
                on = window.on,
                nodash = window.nodash,
                expect = chai.expect,
                body = dom.byId('tests'),
                data = [
                    {label: 'Orange', value: 'orange'},
                    {label: 'Red', value: 'red'},
                    {label: 'Blue', value: 'blue'},
                    {label: 'Green', value: 'green'}
                ],
                dataNums = [
                    {label: 'Uno', value: 1},
                    {label: 'Dos', value: 2},
                    {label: 'Tre', value: 3},
                    {label: 'Qua', value: 4}
                ],
                dataS = [
                    {label: 'Orange', value: 'orange'},
                    {label: 'Red', value: 'red'},
                    {label: 'Blue', value: 'blue', selected: true},
                    {label: 'Green', value: 'green'}
                ],
                data4 = [
                    {label: '<span>&spades;</span> Spades', value: 'spades', class: 'spades'},
                    {label: '<span>&clubs;</span> Clubs', value: 'clubs', selected: true, class: 'clubs'},
                    {label: '<span>&diams;</span> Diamonds', value: 'diamonds', class: 'diamonds'},
                    {label: 'Joker', value: 'joker', class: 'joker'},
                    {label: '<span>&hearts;</span> Hearts', value: 'hearts', class: 'hearts'}
                ],
                dataQnA = [
                    {
                        value: 1,
                        label: 'What is a potential pitfall with using typeof bar === "object" to determine if bar is an object? How can this pitfall be avoided?'
                    }, {
                        value: 2,
                        label: 'What is the significance of, and reason for, wrapping the entire content of a JavaScript source file in a function block?'
                    }, {
                        value: 3,
                        label: 'What is the significance, and what are the benefits, of including \'use strict\' at the beginning of a JavaScript source file?'
                    }, {
                        value: 4,
                        label: 'Consider the two functions below. Will they both return the same thing? Why or why not?'
                    }, {
                        value: 5,
                        label: 'Write a simple function (less than 160 characters) that returns a boolean indicating whether or not a string is a palindrome.'
                    }
                ],
                dataAlias = [
                    {
                        value: 1,
                        alias: 'Q1',
                        label: 'What is a potential pitfall with using typeof bar === "object" to determine if bar is an object? How can this pitfall be avoided?'
                    }, {
                        value: 2,
                        alias: 'Q2',
                        label: 'What is the significance of, and reason for, wrapping the entire content of a JavaScript source file in a function block?'
                    }, {
                        value: 3,
                        alias: 'Q3',
                        label: 'What is the significance, and what are the benefits, of including \'use strict\' at the beginning of a JavaScript source file?'
                    }, {
                        value: 4,
                        alias: 'Q4',
                        label: 'Consider the two functions below. Will they both return the same thing? Why or why not?'
                    }, {
                        value: 5,
                        alias: 'Q5',
                        label: 'Write a simple function (less than 160 characters) that returns a boolean indicating whether or not a string is a palindrome.'
                    }
                ];

            const alpha = 'abcdefgh'.toUpperCase().split('');

            function makeLongList() {
                const list = [];
                alpha.forEach(function (a) {
                    alpha.forEach(function (b) {
                        list.push({
                            label: a + b,
                            value: (a + b).toLowerCase()
                        });
                    });
                });
                return list.splice(0, 100);
            }

            const dataLongList = makeLongList();


            describe('ui-dropdown', function () {
                let node, btn, items, lis;

                function ready(cb) {
                    onDomReady(node, function () {
                        lis = dom.queryAll(node.popup, 'li');
                        items = lis.map(function (n) {
                            return {
                                value: n.getAttribute('value'),
                                label: n.textContent
                            }
                        });
                        setTimeout(cb, 1);
                    });
                }

                function click() {
                    on.emit(btn, 'click');
                }

                function clickoff(cb) {
                    setTimeout(function () {
                        on.emit(document.body, 'click');
                        cb();
                    }, 110);
                }

                function select(index) {
                    return new Promise(function (resolve) {
                        node.once('open', function () {
                            on.emit(node.list.list.children[index], 'mousedown');
                        });
                        node.once('close', function () {
                            setTimeout(function () {
                                resolve(node.value);
                            }, 30);
                        });
                        on.emit(node.button, 'click');
                    });
                }

                describe('render', function () {
                    it('should render a dropdown', function (done) {
                        node = dom('ui-dropdown', {data: data, label: 'Simple drop', placeholder: 'Select'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(4);
                            done();
                        });
                    });
                    it('should handle no data', function (done) {
                        node = dom('ui-dropdown', {data: [], label: 'No Data'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(0);
                            done();
                        });
                    });
                    it('should sort items', function (done) {
                        node = dom('ui-dropdown', {data: data, label: 'Sorted', sortdesc: 'value'}, body);
                        ready(function () {
                            expect(items[0].value).to.equal('blue');
                            expect(items[1].value).to.equal('green');
                            expect(items[2].value).to.equal('orange');
                            expect(items[3].value).to.equal('red');
                            done();
                        });
                    });
                    it('should sort items asc', function (done) {
                        node = dom('ui-dropdown', {data: data, label: 'Sorted Ascending', sortasc: 'value'}, body);
                        ready(function () {
                            expect(items[0].value).to.equal('red');
                            expect(items[1].value).to.equal('orange');
                            expect(items[2].value).to.equal('green');
                            expect(items[3].value).to.equal('blue');
                            done();
                        });
                    });
                    it('should render emojis', function (done) {
                        node = dom('ui-dropdown', {data: data4, label: 'Emojis', placeholder: 'Select an option'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(5);
                            done();
                        });
                    });
                    it('should handle very long options', function (done) {
                        node = dom('ui-dropdown', {data: dataQnA, label: 'Long Options', placeholder: 'Select a long option..'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(5);
                            done();
                        });
                    });
                    it('should use an alias', function (done) {
                        node = dom('ui-dropdown', {data: dataAlias, label: 'Alias', placeholder: 'Doit'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(5);
                            done();
                        });
                    });
                    it('should handle long lists', function (done) {
                        node = dom('ui-dropdown', {data: dataLongList, label: 'Long List', placeholder: 'Pick...', class: 'top-right'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(64);
                            done();
                        });
                    });
                    it('should initialize selection from data', function (done) {
                        node = dom('ui-dropdown', {data: dataS, label: 'Initial Data Selection', placeholder: 'Select'}, body);
                        ready(function () {
                            expect(lis.length).to.equal(4);
                            done();
                        });
                    });
                    it('should initialize selection from parent value', function (done) {
                        node = dom('ui-dropdown', {data: data, value: 'blue', label: 'Initial Parent Value', placeholder: 'Select'}, body);
                        done();
                    });
                });

                describe('events', function () {
                    it('should emit numbers', (done) => {
                        node = dom('ui-dropdown', {data: dataNums, label: 'Numeric Values'}, body);
                        ready(async function () {
                            const events = [];
                            node.on('change', function (e) {
                                events.push(e.value);
                            });
                            await select(1);
                            expect(events.length).to.equal(1);
                            expect(events[0]).to.equal(2);
                            done();
                        });
                    });
                    it('should emit one event when selecting', (done) => {
                        node = dom('ui-dropdown', {data: data, label: 'Events', placeholder: 'Select'}, body);
                        ready(async function () {
                            const events = [];
                            node.on('change', function (e) {
                                events.push(e.value);
                            });
                            await select(1);
                            expect(events.length).to.equal(1);
                            expect(events[0]).to.equal('red');
                            done();
                        });
                    });
                    it('should emit one event even when starting with a selection', (done) => {
                        node = dom('ui-dropdown', {data: dataS, label: 'Event - Selected', placeholder: 'Select'}, body);
                        const events = [];
                        node.on('change', function (e) {
                            events.push(e.value);
                        });
                        ready(async function () {
                            await select(1);
                            expect(events.length).to.equal(1);
                            expect(events[0]).to.equal('red');
                            done();
                        });
                    });
                    it('should emit one event even when starting with a value', (done) => {
                        node = dom('ui-dropdown', {data: data, label: 'Event - Value', value: 'orange'}, body);
                        const events = [];
                        node.on('change', function (e) {
                            events.push(e.value);
                        });
                        ready(async function () {
                            await select(2);
                            expect(events.length).to.equal(1);
                            expect(events[0]).to.equal('blue');
                            done();
                        });
                    });

                    it('should emit one event even when re-setting data', (done) => {
                        node = dom('ui-dropdown', {data: data, label: 'Event - Value Reset', value: 'orange'}, body);
                        const events = [];
                        node.on('change', function (e) {
                            events.push(e.value);
                        });
                        ready(function () {
                            const TIME = 1;
                            setTimeout(() => {
                                node.data = data;
                                setTimeout(() => {
                                    node.data = data;
                                    setTimeout(() => {
                                        node.data = data;
                                        expect(events.length).to.equal(0);
                                        done();
                                    }, TIME);
                                }, TIME);
                            }, TIME);
                        });
                    });
                });

                describe('positioning', function () {
                    it('should handle very long options, middle button', function (done) {
                        node = dom('ui-dropdown', {data: dataQnA, label: 'Long Options Middle', class: 'abs-mid'}, body);
                        done();
                    });
                    it('should truncate display, right-bottom button', function (done) {
                        const container = dom('section', {class: 'abs-bot'}, body);
                        node = dom('ui-dropdown', {data: dataQnA, label: 'Long Options Bottom Right'}, container);
                        done();
                    });
                });

                describe('lazy loading', function () {
                    it('should lazy load options', function (done) {
                        node = dom('ui-dropdown', {data: dataQnA, label: 'Long Options Middle', class: 'abs-mid'}, body);
                        done();
                    })
                });

                describe('destroying', function () {
                    it.only('should should destroy ropdowns without errors', function (done) {
                        [
                            dom('ui-dropdown', {data: data, label: 'Destroy'}, body),
                            // dom('ui-dropdown', {data: data, label: 'Destroy'}, body),
                            // dom('ui-dropdown', {data: data, label: 'Destroy'}, body),
                            // dom('ui-dropdown', {data: data, label: 'Destroy'}, body),
                            // dom('ui-dropdown', {data: data, label: 'Destroy'}, body)
                        ].forEach((node) => {
                            dom.destroy(node);
                        })

                        done();
                    })
                });




            });
        });

        if (!/puppeteer/.test(location.hash)) {
            mocha.run();
        }

    </script>

</body>

</html>