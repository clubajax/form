<!DOCTYPE HTML>
<html lang="en">

<head>
    <title>Test List</title>
    <script src="src/test-files.js"></script>
    <style>
        body {
            padding: 20px 20px 100px 20px;
            font-family: sans-serif;
        }

        .custom div:first-child {
            font-weight: bold;
        }

        .custom div:last-child {
            color: #aaa;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>Test List</h1>
    <div id="mocha"></div>
    <input style="margin-bottom: 10px;" />
    <template id="template-1">
        <ui-list id="declarative">
            <li value="1">One</li>
            <li value="2">Dos</li>
            <li value="3">Tre</li>
        </ui-list>
    </template>
    <div id="tests">
    </div>
    <script>

        mocha.setup('bdd');

        describe('List', function () {
            this.timeout(3000);
            const
                describe = window.describe,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                body = dom.byId('tests'),
                data = [
                    {label: 'Orange', value: 'orange'},
                    {label: 'Red', value: 'red'},
                    {label: 'Blue', value: 'blue'},
                    {label: 'Green', value: 'green'}
                ],
                data2 = [
                    {label: 'Puppy', value: 'puppy'},
                    {label: 'Birdy', value: 'birdy'},
                    {label: 'Kitty', value: 'kitty'},
                    {label: 'Snakey', value: 'snakey'}
                ],
                data3 = [
                    dom('li', {html: 'Mike Wilcox'}),
                    dom('li', {html: 'Lance Cox'}),
                    dom('li', {html: 'Bob Byron'}),
                    dom('li', {html: 'Ben Jones'})
                ],
                data4 = [
                    dom('li', {
                        value: 'Boston',
                        class: 'custom', html: [
                            dom('div', {html: 'Boston'}),
                            dom('div', {html: 'Massachussetts'})
                        ]
                    }),
                    dom('li', {
                        value: 'Detroit',
                        class: 'custom', html: [
                            dom('div', {html: 'Detroit'}),
                            dom('div', {html: 'Michigan'})
                        ]
                    }),
                    dom('li', {
                        value: 'Milwaukee',
                        class: 'custom', html: [
                            dom('div', {html: 'Milwaukee'}),
                            dom('div', {html: 'Wisconsin'})
                        ]
                    }),
                    dom('li', {
                        value: 'Las Vega',
                        class: 'custom', html: [
                            dom('div', {html: 'Las Vegas'}),
                            dom('div', {html: 'Nevada'})
                        ]
                    })
                ],
                data5 = function () {
                    return [
                        {label: 'Puppy', value: 'puppy'},
                        {label: 'Birdy', value: 'birdy'},
                        {label: 'Kitty', value: 'kitty'},
                        {label: 'Snakey', value: 'snakey'}
                    ];
                },
                data6 = [
                    {label: 'Orange', value: 'orange'},
                    {label: 'Red', value: 'red', selected: true},
                    {label: 'Blue', value: 'blue', selected: true},
                    {label: 'Green', value: 'green'}
                ];

            let node;

            function click(index) {
                const lis = dom.queryAll(node.popup, 'li');
                node.once('open', function () {
                    on.emit(lis[index], 'click');
                });
                on.emit(node.button, 'click');
            }

            function key(k) {
                on.emit(node.list, 'keydown', {key: k});
            }


            let value;
            let items;
            function setup(options) {
                node = dom('ui-list', options, body);
                node.onDomReady(function () {
                    items = dom.queryAll(node, 'li');
                });
                on(node, 'dom-update', () => {
                    items = dom.queryAll(node, 'li');
                });
                value = false;
                on(node, 'change', function (e) {
                    value = e.value;
                });
            }

            function update() {
                items = dom.queryAll(node, 'li');
            }

            function destroy() {
                node.destroy();
                value = false;
            }

            function testKeyNav() {
                node.list.focus();
                key('ArrowDown');
                expect(items[1].getAttribute('aria-current')).to.equal('true');
                key('ArrowDown');
                key('Enter');
                expect(items[2].getAttribute('aria-selected')).to.equal('true');
            }

            function expectMultiValue(expectValue, compareValue = node.value) {
                expect(expectValue.length).to.equal(compareValue.length);
                expectValue.forEach((v, i) => {
                    expect(v).to.equal(compareValue[i]);
                })
            }

            describe('Single select', () => {
                it('should render a simple, selectable list', function (done) {
                    setup({data: data, label: 'Simple List'});
                    onDomReady(node, function () {
                        node.list.focus();
                        key('ArrowDown');
                        expect(items[0].getAttribute('aria-current')).to.equal('true');
                        key('ArrowDown');
                        key('Enter');
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(value).to.equal('red');
                        done();
                    });
                });

                it('should clear the selection', function (done) {
                    setup({data: data, label: 'clear selection'});
                    onDomReady(node, function () {
                        node.list.focus();
                        key('ArrowDown');
                        expect(items[0].getAttribute('aria-current')).to.equal('true');
                        key('ArrowDown');
                        key('Enter');
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(value).to.equal('red');

                        node.value = null;
                        expect(node.value).to.equal(null);
                        expect(items[1].getAttribute('aria-selected')).to.equal(null);
                        done();
                    });
                });

                it('should programmatically set a value', function (done) {
                    setup({data: data, label: 'Programmatic Value'});
                    node.value = 'blue';
                    onDomReady(node, function () {
                        expect(items[2].getAttribute('aria-selected')).to.equal('true');
                        node.value = 'red';
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        done();
                    });
                });

                it('should render readonly and with a label', function (done) {
                    setup({data: data, readonly: true, label: 'Read Only List'});
                    onDomReady(node, function () {

                        node.list.focus();
                        // expect(document.activeElement).to.equal(document.body);

                        key('ArrowDown');
                        expect(items[1].getAttribute('aria-current')).to.equal(null);
                        key('ArrowDown');
                        key('Enter');
                        expect(items[2].getAttribute('aria-selected')).to.equal(null);
                        expect(value).to.equal(false);
                        destroy();
                        done();
                    });
                });

                it('should render disabled and with a label', function (done) {
                    setup({data: data, disabled: true, label: 'Disabled List'});
                    onDomReady(node, function () {
                        const items = dom.queryAll(node, 'li');
                        node.list.focus();
                        // expect(document.activeElement).to.equal(document.body);

                        key('ArrowDown');
                        expect(items[1].getAttribute('aria-current')).to.equal(null);
                        key('ArrowDown');
                        key('Enter');
                        expect(items[2].getAttribute('aria-selected')).to.equal(null);
                        expect(value).to.equal(false);
                        destroy();
                        done();
                    });
                });

                it('should render simple custom items', function (done) {
                    setup({data: data3, label: 'Simple Custom Items'});
                    onDomReady(node, function () {
                        node.list.focus();
                        key('ArrowDown');
                        expect(items[0].getAttribute('aria-current')).to.equal('true');
                        key('ArrowDown');
                        key('Enter');
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(value).to.equal('lance-cox');
                        expect(items[1].innerHTML).to.equal('Lance Cox');
                        // destroy();
                        done();
                    });
                });

                it('should render complex custom items', function (done) {
                    setup({data: data4, label: 'Complex Custom Items'});
                    onDomReady(node, function () {
                        node.list.focus();
                        key('ArrowDown');
                        expect(items[0].getAttribute('aria-current')).to.equal('true');
                        key('ArrowDown');
                        key('Enter');
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(value).to.equal('Detroit');
                        expect(items[1].textContent).to.equal('DetroitMichigan');
                        // destroy();
                        done();
                    });
                });

                it('should render with lazy data', function (done) {
                    setup({data: data5, label: 'Lazy data'});
                    onDomReady(node, function () {
                        node.setLazyData();
                        expect(items.length).to.equal(4);
                        done();
                    });
                });

                it('should use dom children declaratively', function (done) {
                    const template = dom.byId('template-1');
                    const clone = template.content.cloneNode(true);
                    dom.byId('tests').appendChild(clone);
                    node = dom.byId('declarative');
                    onDomReady(node, function () {
                        expect(node.data.length).to.equal(3);
                        items = dom.queryAll(node, 'li');
                        node.list.focus();
                        key('ArrowDown');
                        expect(items[0].getAttribute('aria-current')).to.equal('true');
                        key('ArrowDown');
                        key('Enter');
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(node.value).to.equal('2');
                        done();
                    });
                });
            
                it('should skip disabled items', function(done) {
                    done();
                });
            });

            describe('Multi Select', function () {
                it('should select multiple items', function (done) {
                    setup({data: data, label: 'select multiple items', multiple: true});
                    key('ArrowDown');
                    key('Enter');
                    key('ArrowDown');
                    key('Shift');
                    key('Enter');
                    expectMultiValue(['orange', 'red']);
                    done();
                });
                it('should select one item with multiple option', function (done) {
                    setup({data: data, label: 'select one item with multiple', multiple: true});
                    key('ArrowDown');
                    key('Enter');
                    key('ArrowDown');
                    key('Enter');
                    expectMultiValue(['red']);
                    done();
                });
                it('should have initial multiple values', function (done) {
                    setup({data: data6, label: 'initial multiple values', multiple: true});
                    onDomReady(node, function () {
                        expectMultiValue(['red', 'blue']);
                        done();
                    });
                });
                it('should programmatically set multiple values', function (done) {
                    setup({data: data, label: 'select multiple items', multiple: true});
                    onDomReady(node, function () {
                        node.value = ['red', 'blue'];
                        expect(items[1].getAttribute('aria-selected')).to.equal('true');
                        expect(items[2].getAttribute('aria-selected')).to.equal('true');
                        done();
                    });
                });
                it('should clear a multiple selection', function (done) {
                    setup({data: data6, label: 'initial multiple values', multiple: true});
                    onDomReady(node, function () {
                        expectMultiValue(['red', 'blue']);
                        node.value = null;
                        expectMultiValue([]);
                        done();
                    });
                });
            });

            describe('Modify List', function () {
                const getListValues = () => items.map(node => node.getAttribute('value'));

                it('should replace the data', function (done) {
                    setup({data: data, label: 'replace data'});
                    onDomReady(node, function () {
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green"]);
                        node.data = data2;
                        update();
                        expectMultiValue(getListValues(), ["puppy", "birdy", "kitty", "snakey"]);
                        done();
                    });
                });
                it('should add an item', function (done) {
                    setup({data: data, label: 'add an item'});
                    onDomReady(node, function () {
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green"]);
                        node.addData({
                            value: 'purple',
                            label: 'Purple'
                        });
                        update(); 
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green", "purple"]);
                        done();
                    });
                });
                it('should add multiple items', function (done) {
                    setup({data: data, label: 'add multiple items'});
                    onDomReady(node, function () {
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green"]);
                        node.addData([{
                            value: 'purple',
                            label: 'Purple'
                        }, {
                            value: 'black',
                            label: 'Black'
                        }]);
                        update();
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green", "purple", "black"]);
                        done();
                    });
                });
                it('should remove an item', function (done) {
                    setup({data: data, label: 'remove an item'});
                    onDomReady(node, function () {
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green"]);
                        node.removeData('red');
                        update();
                        expectMultiValue(getListValues(), ["orange", "blue", "green"]);
                        done();
                    });
                });
                it('should remove items', function (done) {
                    setup({data: data, label: 'remove items'});
                    onDomReady(node, function () {
                        expectMultiValue(getListValues(), ["orange", "red", "blue", "green"]);
                        node.removeData(['red', 'orange']);
                        update();
                        expectMultiValue(getListValues(), ["blue", "green"]);
                        done();
                    });
                });
            });
        });

        mocha.run();

    </script>

</body>

</html>
